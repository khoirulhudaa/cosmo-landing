<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>AR Loader</title>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
    #unity-canvas { width: 100vw; height: 100vh; display: block; }
    #loading { position: fixed; inset: 0; background: #111; color: #0ff;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-family: Arial; z-index: 999; }
    .spinner { width: 60px; height: 60px; border: 6px solid #333;
      border-top: 6px solid #0ff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div>Memuat AR... <span id="progress">0</span>%</div>
  </div>
  <canvas id="unity-canvas"></canvas>

  <script>
    const buildUrl = "/unity-build/Build";
    const config = {
      dataUrl: buildUrl + "/3dfc59c974755dee151d250cb020d8bd.data.unityweb",
      frameworkUrl: buildUrl + "/f52347dc2ab1959d1e759a6f582b4b30.js.unityweb",
      codeUrl: buildUrl + "/73b6b973f99e58b13f9e27103060aa86.wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "DefaultCompany",
      productName: "WebAR Product Cosmo",
      productVersion: "0.1",
    };

    const canvas = document.getElementById("unity-canvas");
    const loading = document.getElementById("loading");
    const progressEl = document.getElementById("progress");

    // Fungsi memulai Unity
    function startUnity() {
      const script = document.createElement("script");
      script.src = buildUrl + "/Build.loader.js";
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressEl.textContent = Math.round(progress * 100);
        }).then((instance) => {
          loading.style.display = "none";
          window.unityInstance = instance;
          window.parent.postMessage({ type: "UNITY_LOADED" }, "*");
        }).catch((err) => {
          alert("Gagal load AR: " + err.message);
        });
      };
      document.body.appendChild(script);
    }

    // ✅ Urutan aman dan cepat
    async function startAR() {
      try {
        // 1️⃣ Pastikan library Zappar CV sudah dimuat
        await new Promise((resolve, reject) => {
          const zapparScript = document.createElement("script");
          zapparScript.src = "https://libs.zappar.com/zappar-cv/2.1.3/zappar-cv.js";
          zapparScript.onload = resolve;
          zapparScript.onerror = () => reject(new Error("Gagal memuat Zappar CV"));
          document.head.appendChild(zapparScript);
        });

        // 2️⃣ Minta izin kamera (memicu popup bawaan browser)
        await navigator.mediaDevices.getUserMedia({ video: true });

        // 3️⃣ Inisialisasi Zappar
        const zappar = window.ZCV.initialize();
        await zappar.permission_request_ui_promise();

        // 4️⃣ Tunggu siap, lalu jalankan Unity
        const waitLoaded = () => {
          if (zappar.loaded()) startUnity();
          else setTimeout(waitLoaded, 100);
        };
        waitLoaded();

      } catch (err) {
        alert("Akses kamera ditolak atau tidak tersedia: " + err.message);
        console.error(err);
      }
    }

    window.addEventListener("load", startAR);
  </script>
</body>
</html> -->


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>AR Loader</title>
  <style>
    body, html { 
      margin: 0; padding: 0; overflow: hidden; background: #000; 
      touch-action: none;
    }
    #unity-canvas { 
      width: 100vw; height: 100vh; display: block; 
      /* JANGAN PAKAI scaleX(-1) di sini! */
    }
    #loading { 
      position: fixed; inset: 0; background: #111; color: #0ff;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-family: Arial, sans-serif; z-index: 999; 
    }
    .spinner { 
      width: 60px; height: 60px; border: 6px solid #333;
      border-top: 6px solid #0ff; border-radius: 50%; 
      animation: spin 1s linear infinite; margin-bottom: 20px; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Tombol debug (bisa dihapus di produksi) */
    #debug-btn {
      position: fixed; top: 80px; right: 20px; z-index: 1000;
      padding: 10px 12px; background: #0ff; color: #000; 
      border: none; border-radius: 8px; font-weight: bold;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div>Memuat AR... <span id="progress">0</span>%</div>
    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">Izinkan kamera</div>
  </div>

  <canvas id="unity-canvas"></canvas>
  <video id="camera-feed" autoplay playsinline style="display: none;"></video>

  <!-- Tombol debug: Flip Manual -->
  <button id="debug-btn" onclick="toggleManualFlip()">Flip</button>

  <script>
    const buildUrl = "/unity-build/Build";
    const config = {
      dataUrl: buildUrl + "/3dfc59c974755dee151d250cb020d8bd.data.unityweb",
      frameworkUrl: buildUrl + "/f52347dc2ab1959d1e759a6f582b4b30.js.unityweb",
      codeUrl: buildUrl + "/73b6b973f99e58b13f9e27103060aa86.wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "DefaultCompany",
      productName: "WebAR Product Cosmo",
      productVersion: "0.1",
    };

    const canvas = document.getElementById("unity-canvas");
    const loading = document.getElementById("loading");
    const progressEl = document.getElementById("progress");
    const video = document.getElementById("camera-feed");

    let stream = null;
    let isFrontCamera = false;
    let needsTextureFlip = false; // Unity perlu flip texture?
    let manualFlip = false;

    // --- FUNGSI UTAMA ---
    async function startAR() {
      try {
        // 1. Minta akses kamera BELAKANG
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "environment",  // PAKSA BELAKANG
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });

        video.srcObject = stream;
        await video.play();

        // 2. Deteksi: Android + rear camera → Unity flip otomatis
        const isAndroid = /Android/i.test(navigator.userAgent);
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        isFrontCamera = settings.facingMode === "user";

        // Logika flip:
        // - Android + rear camera → Unity flip X → kita balikkan di texture
        // - iOS / depan → biarkan seperti cermin
        needsTextureFlip = isAndroid && !isFrontCamera;

        // 3. Load Zappar CV
        await loadZappar();

        // 4. Tunggu Zappar siap → jalankan Unity
        waitForZapparAndStartUnity();

      } catch (err) {
        alert("Akses kamera ditolak: " + err.message);
        console.error(err);
      }
    }

    function loadZappar() {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = "https://libs.zappar.com/zappar-cv/2.1.3/zappar-cv.js";
        script.onload = resolve;
        script.onerror = () => reject(new Error("Gagal load Zappar"));
        document.head.appendChild(script);
      });
    }

    function waitForZapparAndStartUnity() {
      const zappar = window.ZCV.initialize();
      zappar.permission_request_ui_promise().then(() => {
        const check = () => {
          if (zappar.loaded()) {
            startUnity();
          } else {
            setTimeout(check, 100);
          }
        };
        check();
      });
    }

    function startUnity() {
      const script = document.createElement("script");
      script.src = buildUrl + "/Build.loader.js";
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressEl.textContent = Math.round(progress * 100);
        }).then((instance) => {
          loading.style.display = "none";
          window.unityInstance = instance;

          // Kirim ke Unity: apakah perlu flip texture?
          window.unityInstance.SendMessage('ARController', 'SetMirrorMode', needsTextureFlip ? 1 : 0);

          // Kirim event loaded ke parent (React)
          window.parent.postMessage({ type: "UNITY_LOADED" }, "*");
        }).catch((err) => {
          alert("Gagal load Unity: " + err.message);
        });
      };
      document.body.appendChild(script);
    }

    // --- FITUR TAMBAHAN: FLIP MANUAL (DEBUG) ---
    function toggleManualFlip() {
      manualFlip = !manualFlip;
      const scale = manualFlip ? -1 : 1;
      canvas.style.transform = `scaleX(${scale})`;
      document.getElementById('debug-btn').textContent = manualFlip ? 'Unflip' : 'Flip';
    }

    // --- MULAI ---
    window.addEventListener("load", startAR);
  </script>
</body>
</html>