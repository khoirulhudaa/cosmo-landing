<script>
  const buildUrl = "/unity-build/Build";
  const config = {
    dataUrl: buildUrl + "/5e30b6e1da5853808344359921df6a0b.data.unityweb",
    frameworkUrl: buildUrl + "/f52347dc2ab1959d1e759a6f582b4b30.js.unityweb",
    codeUrl: buildUrl + "/73b6b973f99e58b13f9e27103060aa86.wasm.unityweb",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "DefaultCompany",
    productName: "WebAR Product Cosmo",
    productVersion: "0.1",
    cacheControl: (url) => {
      if (url.match(/\.data/) || url.match(/\.bundle/) || url.match(/\.zpt/)) return "immutable";
      if (url.match(/\.mp4/) || url.match(/\.custom/) || url.match(/\.zbin/)) return "immutable";
      return "no-store";
    },
  };

  const canvas = document.getElementById('unity-canvas');
  const loading = document.getElementById('loading');
  const progressEl = document.getElementById('progress');

  async function requestCamera() {
    try {
      // ðŸ”¸ Minta izin kamera â€” ini yang memicu popup bawaan browser
      await navigator.mediaDevices.getUserMedia({ video: true });

      // Setelah diizinkan, baru inisialisasi Zappar
      window.zappar = ZCV.initialize();
      await window.zappar.permission_request_ui_promise();
      waitForZappar();
    } catch (err) {
      alert('Akses kamera ditolak atau tidak tersedia: ' + err.message);
    }
  }

  function waitForZappar() {
    if (window.zappar && window.zappar.loaded()) {
      startUnity();
    } else {
      setTimeout(waitForZappar, 100);
    }
  }

  function startUnity() {
    const script = document.createElement('script');
    script.src = buildUrl + "/Build1.loader.js";
    script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
        progressEl.textContent = Math.round(progress * 100);
      }).then((instance) => {
        loading.style.display = 'none';
        window.unityInstance = instance;
        window.parent.postMessage({ type: 'UNITY_LOADED' }, '*');
      }).catch((err) => {
        alert('Gagal load AR: ' + err.message);
      });
    };
    document.body.appendChild(script);
  }

  // ðŸ”¹ Jalankan langsung saat halaman dimuat
  window.addEventListener('load', requestCamera);
</script>
