<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>AR Loader</title>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
    #loading { position: fixed; inset: 0; background: #111; color: #0ff;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-family: Arial; z-index: 999; }
    .spinner { width: 60px; height: 60px; border: 6px solid #333;
      border-top: 6px solid #0ff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div>Memuat AR... <span id="progress">0</span>%</div>
  </div>
  <canvas id="unity-canvas"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://libs.zappar.com/zappar-threejs/2.4.6/zappar-threejs.js"></script>

  <script>

    const send = (type, data = {}) => {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type, ...data }, '*');
      }
    };
    
    const canvas = document.getElementById('unity-canvas');
    const renderer = new THREE.WebGLRenderer({ antialias: true, canvas });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);

    ZapparThree.glContextSet(renderer.getContext());

    const scene = new THREE.Scene();
    const camera = new ZapparThree.Camera();
    scene.background = camera.backgroundTexture;

    ZapparThree.permissionRequestUI().then(granted => {
    if (granted) {
        camera.start();
        console.log('CAMERA READY!')
        send('AR_CAMERA_GRANTED'); // React tahu kamera OK
      } else {
        console.log('CAMERA ERROR!')
        send('AR_ERROR', { message: 'Kamera ditolak' });
        ZapparThree.permissionDeniedUI();
      }
    });
    
    const trackerLoader = new ZapparThree.ImageTrackerLoader();
    trackerLoader.load(
      "/unity-build/StreamingAssets/COSMO 1417-02 marker.zpt",
      (progress) => {
        const p = Math.round(progress * 100);
        document.getElementById('progress').textContent = p;
        console.log('AR PROGRESS...!')
        send('AR_PROGRESS', { progress: p }); // Kirim progress
      },
      (tracker) => {
        console.log("Tracker loaded!");
        send('AR_LOADED'); 
        const trackerGroup = new ZapparThree.ImageAnchorGroup(camera, tracker);
        scene.add(trackerGroup);

        const cube = new THREE.Mesh(
          new THREE.BoxGeometry(0.5, 0.5, 0.5),
          new THREE.MeshBasicMaterial({ color: 0x00ff00 })
        );
        trackerGroup.add(cube);

        function animate() {
          requestAnimationFrame(animate);
          cube.rotation.x += 0.01;
          cube.rotation.y += 0.01;
          camera.updateFrame(renderer);
          renderer.render(scene, camera);
        }
        animate();

        document.getElementById('loading').style.display = 'none';
      },
      (error) => {
        console.error("Load failed:", error);
        console.log('AR ERROR...!')
        send('AR_ERROR', { message: 'Gagal load marker' });
      }
    );
    
    window.addEventListener('resize', () => {
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html> -->


<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Multi Produk COSMO®</title>
  
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Segoe UI', sans-serif;
    }

    /* LOADING */
    #loadingScreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      pointer-events: none;
      transition: opacity 0.6s ease;
    }
    #loadingScreen.hidden { opacity: 0; }
    .spinner {
      width: 50px; height: 50px;
      border: 4px solid #333;
      border-top: 4px solid #4fc3f7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    #loadingText { font-size: 16px; color: #ccc; text-align: center; max-width: 80%; }
    #loadingText strong { color: #4fc3f7; }

    a-scene { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none !important; }
    .ar-model { pointer-events: auto !important; transform-style: preserve-3d; }

    /* YOUTUBE CONTAINER */
    #youtubeContainer {
      position: absolute;
      top: 4%; right: 1.5%;
      width: 75vw; max-width: 320px; min-width: 180px;
      height: 91vh; border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.37), inset 0 0 20px rgba(255,255,255,0.05);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      background: rgba(20,20,30,0.35); border: 1px solid rgba(255,255,255,0.18);
      display: flex; flex-direction: column;
      transition: height 0.5s cubic-bezier(0.4,0,0.2,1), transform 0.5s ease;
      z-index: 999999000; pointer-events: auto;
    }
    #youtubeContainer.compact { height: 8.5vh; overflow: hidden; }
    #youtubeContainer.compact .info-section, #youtubeContainer.compact .wrap-btn, #youtubeContainer.compact #videoFrame { display: none !important; }
    #youtubeContainer.hidden { opacity: 0; transform: translateX(150%); pointer-events: none; }

    #videoFrame { width: 100%; height: 500px; overflow: hidden; transition: all 0.4s ease; border-radius: 16px 16px 0 0; }
    #videoFrame.hidden { height: 0; opacity: 0; padding: 0; margin: 0; }
    #youtubeIframe { width: 100%; height: 100%; border: none; border-radius: 16px 16px 0 0; }

    #productCard { padding: 16px; max-height: 100%; overflow-y: auto; font-size: 12.5px; line-height: 1.5;
      background: rgba(15,15,25,0.4); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.1); color: #eee; }
    #productCard h3 { margin: 0 0 8px; font-size: 16px; color: #fff; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      display: flex; align-items: center; }
    #productCard p { margin: 6px 0; font-size: 12.5px; color: #ddd; line-height: 1.4; }
    .info-section { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed rgba(79,195,247,0.3); }
    .info-section:last-of-type { border: none; margin-bottom: 8px; }
    #productCard::-webkit-scrollbar { width: 5px; }
    #productCard::-webkit-scrollbar-thumb { background: rgba(79,195,247,0.6); border-radius: 3px; }

    .wrap-btn { display: flex; gap: 8px; margin-bottom: 12px; }
    #toggleVideoBtn, #downloadPdfBtn {
      display: flex; align-items: center; gap: 6px; padding: 6px 11px; border-radius: 8px;
      font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); text-decoration: none;
    }
    #toggleVideoBtn { background: rgba(255,255,255,0.25); color: #ddd; border: 1px solid rgba(255,255,255,0.2); }
    #toggleVideoBtn:hover { background: rgba(255,255,255,0.35); transform: translateY(-1px); }
    #downloadPdfBtn { background: rgba(79,195,247,0.15); color: #4fc3f7; border: 1px solid rgba(79,195,247,0.3); opacity: 0; pointer-events: none; }
    #downloadPdfBtn.visible { opacity: 1; pointer-events: auto; }
    #downloadPdfBtn:hover { background: rgba(79,195,247,0.25); transform: translateY(-2px); }

    #toggleContainerBtn {
      position: fixed; top: 16px; right: 16px; width: 44px; height: 44px; font-size: 20px; font-weight: bold;
      cursor: pointer; z-index: 9999; display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15);
      border-radius: 50%; color: white; transition: all 0.3s ease; pointer-events: auto !important;
    }
    #toggleContainerBtn:hover { transform: scale(1.15); background: rgba(0,0,0,0.7); box-shadow: 0 0 20px rgba(79,195,247,0.3); }

    #toggleHeightBtn { all: unset; cursor: pointer; margin-left: 8px; display: inline-flex; align-items: center; }

    @media (max-width: 480px) {
      #youtubeContainer { top: 4%; right: 4%; width: 92vw; max-width: 300px; border-radius: 18px; }
      #youtubeContainer.compact { height: 8.5vh; }
      #toggleContainerBtn { width: 40px; height: 40px; top: 12px; right: 12px; }
    }

    /* === VOICE WAVE (TENGAH BAWAH) === */
    #voiceWave {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      width: 90px; height: 90px;
      border-radius: 50%; background: conic-gradient(from 0deg, #4fc3f7, #7c4dff, #ff6ec7, #4fc3f7);
      opacity: 0; pointer-events: none; z-index: 99999;
      transition: all 0.3s ease;
    }
    #voiceWave.active {
      opacity: 1; transform: translateX(-50%) scale(1.3);
      animation: pulseWave 1.5s infinite;
    }
    @keyframes pulseWave {
      0%, 100% { box-shadow: 0 0 0 0 rgba(79,195,247,0.7); }
      50% { box-shadow: 0 0 0 40px rgba(79,195,247,0); }
    }
    #voiceWave::before {
      content: ''; position: absolute; inset: 18px; background: #000; border-radius: 50%; z-index: 1;
    }
    #voiceWave::after {
      content: ''; position: absolute; inset: 30px; background: conic-gradient(#4fc3f7, #7c4dff, #ff6ec7);
      border-radius: 50%; z-index: 2; animation: rotate 3s linear infinite;
    }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* === CHATBOT CONTAINER (TENGAH BAWAH) === */
    #chatbotContainer {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 90vw; max-width: 420px; height: 70vh;
      background: rgba(20,20,30,0.92); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.25);
      border-radius: 28px; box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      display: flex; flex-direction: column; z-index: 9999;
      opacity: 0; pointer-events: none;
      transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
    }
    #chatbotContainer.active { opacity: 1; pointer-events: auto; }

    #chatHeader {
      padding: 18px; border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-between; align-items: center; color: white;
    }
    #chatBody {
      flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;
      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent;
    }
    #chatBody::-webkit-scrollbar { width: 5px; }
    #chatBody::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

    #chatInputArea {
      padding: 16px; border-top: 1px solid rgba(255,255,255,0.1);
      display: flex; gap: 8px; align-items: center;
    }
    #chatInput {
      flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      color: white; padding: 14px 18px; border-radius: 18px; font-size: 14px;
    }
    #chatInput::placeholder { color: rgba(255,255,255,0.5); }

    .message {
      max-width: 82%; padding: 11px 16px; border-radius: 18px; font-size: 13.5px; line-height: 1.5;
    }
    .user { align-self: flex-end; background: #4fc3f7; color: white; }
    .bot { align-self: flex-start; background: rgba(255,255,255,0.1); color: #eee; border: 1px solid rgba(255,255,255,0.12); }

    /* === MIC BUTTON (TENGAH BAWAH) === */
    #micBtn {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      width: 70px; height: 70px;
      background: linear-gradient(135deg, #4fc3f7, #7c4dff);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 10px 25px rgba(79,195,247,0.5); cursor: pointer; z-index: 9998;
      transition: all 0.3s ease;
    }
    #micBtn.listening {
      transform: translateX(-50%) scale(1.15);
      box-shadow: 0 0 40px rgba(79,195,247,0.9);
    }
    #micBtn svg { width: 32px; height: 32px; stroke: white; }

    #productSelect {
      background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);
      border-radius: 14px; padding: 10px 14px; font-size: 13px;
    }

    /* Speed Control */
    #speedControl {
      display: flex; gap: 6px; margin-top: 8px; justify-content: center;
    }
    .speedBtn {
      background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 10px; border-radius: 10px; font-size: 11px; cursor: pointer;
      transition: all 0.2s ease;
    }
    .speedBtn.active { background: #4fc3f7; border-color: #4fc3f7; }
  </style>
</head>
<body>

  <!-- LOADING SCREEN -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">
      <strong>Memuat AR...</strong><br>
      Arahkan kamera ke <strong>marker</strong> untuk melihat produk
    </div>
  </div>

  <!-- TOGGLE CONTAINER -->
  <button id="toggleContainerBtn" style="opacity: 0;">Close</button>

  <!-- YOUTUBE CONTAINER -->
  <div id="youtubeContainer" class="hidden">
    <div id="videoFrame" class="hidden">
      <iframe id="youtubeIframe" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
    <div id="productCard">
      <h3 id="productName">
        COSMO® JR-60
        <button id="toggleHeightBtn">
          <svg id="eyeHeightIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4fc3f7" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </h3>

      <div class="wrap-btn">
        <a id="downloadPdfBtn" class="hidden" download>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          <span>PDF</span>
        </a>

        <button id="toggleVideoBtn">
          <svg id="eyeOpen" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          <svg id="eyeClosed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
          </svg>
          <span id="videoBtnText">Lihat Video</span>
        </button>
      </div>

      <div class="info-section"><p id="productDesc"></p></div>
      <div class="info-section"><p id="productSpecs"></p></div>
      <div class="info-section"><p id="productUsage"></p></div>
      <div class="info-section"><p id="productCerts"></p></div>
    </div>
  </div>

  <!-- VOICE WAVE -->
  <div id="voiceWave"></div>

  <!-- MIC BUTTON -->
  <div id="micBtn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
      <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
      <line x1="12" y1="19" x2="12" y2="23"></line>
      <line x1="8" y1="23" x2="16" y2="23"></line>
    </svg>
  </div>

  <!-- CHATBOT CONTAINER -->
  <div id="chatbotContainer">
    <div id="chatHeader">
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="width:40px; height:40px; background:linear-gradient(135deg,#4fc3f7,#7c4dff); border-radius:50%; display:flex; align-items:center; justify-content:center;">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
          </svg>
        </div>
        <div>
          <div style="font-weight:700; font-size:16px;">COSMO Assistant</div>
          <div style="font-size:11px; color:#4fc3f7;">Mendengarkan...</div>
        </div>
      </div>
      <button onclick="toggleChat()" style="background:none; border:none; color:white; cursor:pointer;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div id="chatBody"></div>

    <div id="chatInputArea">
      <select id="productSelect">
        <option value="">Chat Umum</option>
      </select>
      <input id="chatInput" type="text" placeholder="Tanya apa saja..." />
      <button id="sendBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
      </button>
    </div>

    <!-- SPEED CONTROL -->
    <div id="speedControl">
      <button class="speedBtn" data-rate="0.8">0.8x</button>
      <button class="speedBtn active" data-rate="1.0">1.0x</button>
      <button class="speedBtn" data-rate="1.2">1.2x</button>
      <button class="speedBtn" data-rate="1.5">1.5x</button>
    </div>
  </div>

  <!-- A-SCENE -->
  <a-scene embedded arjs="trackingMethod:best;sourceType:webcam;debugUIEnabled:false;" renderer="logarithmicDepthBuffer:true;" vr-mode-ui="enabled:false" loading-screen="dotsColor:#4fc3f7;backgroundColor:#000">
    <a-marker type="pattern" url="/assets/jr60.patt"   data-product-id="1"><a-entity class="ar-model" visible="false"></a-entity></a-marker>
    <a-marker type="pattern" url="/assets/cosmoIMG.patt" data-product-id="2"><a-entity class="ar-model" visible="false"></a-entity></a-marker>
    <a-marker type="pattern" url="/assets/flower.patt"   data-product-id="3"><a-entity class="ar-model" visible="false"></a-entity></a-marker>
    <a-marker type="pattern" url="/assets/astro.patt"    data-product-id="4"><a-entity class="ar-model" visible="false"></a-entity></a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // === DATA PRODUK ===
    const products = [null,
      { id: 1, name: "COSMO® JR-60", description: "COSMO® - JR 60 Wipers...", specs: ["Roll @ 1.000 Lembar", "70-80% Woodpulp", "20-30% Polypropylene (PP)", "34,5 cm x 31 cm per lembar", "Berat 60 GSM", "Lembut & elastis", "Daya serap tinggi"], usage: "Pembersihan Pribadi • Menyeka Permukaan • Menyerap Tumpahan Cairan • Menyerap Minyak, Lemak dan Minyak CPO • Memoles Kaca & Logam • Membersihkan Bak Cuci, Oven, Mesin • Mempersiapkan Permukaan • Mengganti Lap Bekas/Majun", certifications: ["LPPOM MUI", "Laboratorium Independen SIG"], videoId: "YmI52hF2pJ8", model: "/assets/cosmo.glb", pdfUrl: "/assets/jr60.pdf" },
      { id: 2, name: "COSMO® MR-50", description: "COSMO® - MR 50 Wipers...", specs: ["Roll @ 900 Lembar", "70-80% Woodpulp", "20-30% Polypropylene (PP)", "25 cm x 25 cm per lembar", "Berat 50 GSM", "Lembut & elastis", "Daya serap tinggi"], usage: "Pembersihan Pribadi • Menyeka Permukaan • Menyerap Tumpahan Cairan • Menyerap Minyak, Lemak dan Minyak CPO • Memoles Kaca & Logam • Membersihkan Bak Cuci, Oven, Mesin • Mempersiapkan Permukaan • Mengganti Lap Bekas/Majun", certifications: ["LPPOM MUI", "Laboratorium Independen SIG"], videoId: "4HrweW4IqJc", model: "/assets/astronaut.glb", pdfUrl: "/assets/mr50.pdf" },
      { id: 3, name: "COSMO® PSW", description: "Tisu untuk ruang bersih...", specs: ["30 cm x 15 cm (standar)", "100% Polypropylene (PP)", "40 GSM – Low lint", "50 lembar/roll", "6 SKU + Dispenser/Bucket", "Siap pakai dengan IPA"], sku: ["1417-01: 12 Roll @ 50 Lembar", "1417-02: 12 Roll @ 50 Lembar + Dispenser", "1417-04: 685 Roll @ 150 Lembar", "1417-05: 6 Roll @ 150 Lembar + Bucket", "1417-06: 12\"x12\", 6 Roll @ 100 Lembar", "1417-07: 12\"x12\", 6 Roll @ 100 Lembar + Bucket"], usage: "Sanitasi Ruang Bersih • Desinfeksi Laboratorium • Pembersihan Elektronik • Farmasi & Medis • Persiapan Permukaan Steril", certifications: ["LPPOM MUI", "Laboratorium Independen SIG", "ISO 14644", "EPA Compliant"], videoId: "YMcI754wroM", model: "/assets/product-sample.glb", pdfUrl: "/assets/psw.pdf" },
      { id: 4, name: "COSMO® QF-70", description: "COSMO® - QF 70 Wipers...", specs: ["Quarter Fold 30 x 35 cm", "70 GSM – Super kuat", "100 lembar/pack", "1 box = 8 pack", "70-80% Woodpulp", "20-30% Polypropylene (PP)"], usage: "Pembersihan Pribadi • Menyeka Permukaan • Menyerap Tumpahan Cairan • Menyerap Minyak, Lemak dan Minyak CPO • Memoles Kaca & Logam • Membersihkan Bak Cuci, Oven, Mesin • Mempersiapkan Permukaan • Mengganti Lap Bekas/Majun", certifications: ["LPPOM MUI", "Laboratorium Independen SIG"], videoId: "lm3Caq31Djw", model: "/assets/waving.glb", pdfUrl: "/assets/qf70.pdf" }
    ];

    let player;

    // === LOAD YOUTUBE API ===
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScript = document.getElementsByTagName('script')[0];
    firstScript.parentNode.insertBefore(tag, firstScript);

    // === TUNGGU SEMUA SIAP ===
    window.addEventListener('load', () => {
      const loadingScreen = document.getElementById('loadingScreen');
      const container = document.getElementById('youtubeContainer');
      const videoFrame = document.getElementById('videoFrame');
      const toggleContainerBtn = document.getElementById('toggleContainerBtn');
      const toggleVideoBtn = document.getElementById('toggleVideoBtn');
      const eyeOpen = document.getElementById('eyeOpen');
      const eyeClosed = document.getElementById('eyeClosed');
      const videoBtnText = document.getElementById('videoBtnText');
      const downloadPdfBtn = document.getElementById('downloadPdfBtn');
      const toggleHeightBtn = document.getElementById('toggleHeightBtn');
      const eyeHeightIcon = document.getElementById('eyeHeightIcon');

      const productName = document.getElementById('productName');
      const productDesc = document.getElementById('productDesc');
      const productSpecs = document.getElementById('productSpecs');
      const productUsage = document.getElementById('productUsage');
      const productCerts = document.getElementById('productCerts');

      let currentModel = null;
      let lockedProduct = null;
      let hasEverShown = false;

      // === FUNGSI TOGGLE IKON ===
      function showEyeOpen() {
        eyeOpen.style.display = 'block';
        eyeClosed.style.display = 'none';
        videoBtnText.textContent = 'Tutup Video';
      }

      function showEyeClosed() {
        eyeOpen.style.display = 'none';
        if (player) { player.pauseVideo(); player.mute(); }
        eyeClosed.style.display = 'block';
        videoBtnText.textContent = 'Lihat Video';
      }

      function resetVideoButton() {
        videoFrame.classList.add('hidden');
        showEyeClosed();
        if (player) { player.pauseVideo(); player.mute(); }
      }

      // === UPDATE PRODUK ===
      function updateProductDisplay(product) {
        if (!product || (lockedProduct && lockedProduct.id === product.id)) return;
        lockedProduct = product;

        productName.firstChild.textContent = product.name;
        productDesc.innerHTML = `<strong>Deskripsi:</strong><br>${product.description}`;
        let specsHTML = product.specs.map(s => `• ${s}`).join('<br>');
        if (product.sku) specsHTML += '<br><br><strong>SKU Tersedia:</strong><br>' + product.sku.map(s => `• ${s}`).join('<br>');
        productSpecs.innerHTML = `<strong>Spesifikasi:</strong><br>${specsHTML}`;
        productUsage.innerHTML = `<strong>Kegunaan:</strong><br>${product.usage.replace(/ • /g, '<br>')}`;
        productCerts.innerHTML = `<strong>Sertifikasi:</strong><br>${product.certifications.map(c => '✓ ' + c).join('<br>')}`;

        const iframe = document.getElementById('youtubeIframe');
        const newSrc = `https://www.youtube.com/embed/${product.videoId}?autoplay=0&loop=1&playlist=${product.videoId}&controls=1&modestbranding=1&rel=0&mute=0&enablejsapi=1`;
        if (iframe.src !== newSrc) iframe.src = newSrc;

        setTimeout(() => {
          if (player && player.loadVideoById) {
            player.loadVideoById(product.videoId);
            player.pauseVideo();
            player.mute();
          }
        }, 500);

        downloadPdfBtn.href = product.pdfUrl;
        downloadPdfBtn.download = `${product.name.replace(/®/g, '').trim()}.pdf`;
        downloadPdfBtn.classList.add('visible');

        container.classList.remove('hidden');
        toggleContainerBtn.textContent = 'Close';
        resetVideoButton();
      }

      // === TOGGLE VIDEO ===
      toggleVideoBtn.onclick = () => {
        const isHidden = videoFrame.classList.toggle('hidden');
        if (isHidden) {
          player?.pauseVideo(); player?.mute(); showEyeClosed();
        } else {
          player?.playVideo(); player?.unMute(); showEyeOpen();
        }
      };

      // === TOGGLE HEIGHT ===
      toggleHeightBtn.onclick = () => {
        const isCompact = container.classList.toggle('compact');
        eyeHeightIcon.innerHTML = isCompact ? `
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
          <line x1="1" y1="1" x2="23" y2="23"></line>
        ` : `
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        `;
        if (isCompact) resetVideoButton();
      };

      // === TOGGLE CONTAINER ===
      toggleContainerBtn.onclick = () => {
        container.classList.toggle('hidden');
        toggleContainerBtn.textContent = container.classList.contains('hidden') ? 'Play' : 'Close';
        if (container.classList.contains('hidden')) {
          downloadPdfBtn.classList.remove('visible');
          resetVideoButton();
        }
      };

      // === MARKER DETECTION ===
      const markers = document.querySelectorAll('a-marker');
      markers.forEach(marker => {
        const productId = parseInt(marker.getAttribute('data-product-id'));
        const product = products[productId];
        const modelEntity = marker.querySelector('.ar-model');

        marker.addEventListener('markerFound', () => {
          updateProductDisplay(product);

          if (currentModel && currentModel !== modelEntity) {
            currentModel.setAttribute('visible', false);
          }

          if (!modelEntity.model) {
            const gltf = document.createElement('a-entity');
            gltf.setAttribute('gltf-model', product.model);
            gltf.setAttribute('scale', '0.5 0.5 0.5');
            gltf.setAttribute('position', '0 0.5 0');
            gltf.setAttribute('animation-mixer', '');
            gltf.setAttribute('rotation-control', '');
            modelEntity.appendChild(gltf);
            modelEntity.model = gltf;
          }

          modelEntity.setAttribute('visible', true);
          currentModel = modelEntity;
          hasEverShown = true;

          loadingScreen.classList.add('hidden');
          setTimeout(() => { loadingScreen.style.display = 'none'; }, 700);

          // BUKA CHAT OTOMATIS
          if (!document.getElementById('chatbotContainer').classList.contains('active')) {
            setTimeout(toggleChat, 800);
          }
        });
      });

      // === YOUTUBE API SIAP ===
      window.onYouTubeIframeAPIReady = function () {
        player = new YT.Player('youtubeIframe', {
          events: {
            'onReady': (e) => {
              e.target.pauseVideo();
              e.target.mute();
            }
          }
        });
      };

      // === TIMEOUT LOADING ===
      setTimeout(() => {
        if (!loadingScreen.classList.contains('hidden')) {
          loadingScreen.classList.add('hidden');
          setTimeout(() => { loadingScreen.style.display = 'none'; }, 700);
        }
      }, 1000);
    });

    // === ROTATION CONTROL ===
    AFRAME.registerComponent('rotation-control', {
      init: function () {
        const el = this.el;
        let startX = 0, startY = 0, dragging = false;
        el.addEventListener('touchstart', e => {
          if (e.touches.length === 1) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            dragging = true;
          }
        });
        el.addEventListener('touchmove', e => {
          if (!dragging) return;
          e.preventDefault();
          const dx = e.touches[0].clientX - startX;
          const dy = e.touches[0].clientY - startY;
          const rot = el.getAttribute('rotation');
          el.setAttribute('rotation', { x: rot.x - dy * 0.6, y: rot.y + dx * 0.6, z: rot.z });
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        }, { passive: false });
        el.addEventListener('touchend', () => { dragging = false; });
      }
    });

    // === CHATBOT & VOICE SYSTEM ===
    const API_BASE = 'https://vr.kiraproject.id';
    const chatBody = document.getElementById('chatBody');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const voiceWave = document.getElementById('voiceWave');
    const chatbotContainer = document.getElementById('chatbotContainer');
    const productSelect = document.getElementById('productSelect');

    let recognition;
    let isListening = false;
    let speechRate = 1.0;

    // === INIT SPEECH RECOGNITION (SELALU AKTIF) ===
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'id-ID';
      recognition.interimResults = true;
      recognition.continuous = true; // SELALU MENDENGAR

      recognition.onresult = (e) => {
        const transcript = Array.from(e.results)
          .map(r => r[0].transcript)
          .join('').toLowerCase().trim();

        // DETEKSI WAKE WORD
        if (transcript.includes('hallo cosmo') && !isListening) {
          startListening();
          addMessage('user', 'Hallo Cosmo!');
          setTimeout(() => chatInput.focus(), 300);
          return;
        }

        // JIKA SEDANG MENDENGAR & ADA FINAL RESULT
        if (isListening && e.results[e.results.length - 1].isFinal) {
          const final = e.results[e.results.length - 1][0].transcript.trim();
          if (final && !final.toLowerCase().includes('hallo cosmo')) {
            sendMessage(final);
            stopListening();
          }
        }
      };

      recognition.onerror = (e) => {
        console.error('Speech error:', e);
        if (isListening) stopListening();
      };

      recognition.onend = () => {
        // Restart otomatis jika masih dalam mode listening
        if (isListening) {
          setTimeout(() => recognition.start(), 100);
        }
      };

      // MULAI MENDENGAR OTOMATIS SETELAH LOAD
      setTimeout(() => recognition.start(), 2000);
    }

    function startListening() {
      if (!recognition) return;
      isListening = true;
      micBtn.classList.add('listening');
      voiceWave.classList.add('active');
      document.querySelector('#chatHeader div:last-child div:last-child').textContent = 'Mendengarkan...';
      recognition.start();
    }

    function stopListening() {
      isListening = false;
      micBtn.classList.remove('listening');
      voiceWave.classList.remove('active');
      document.querySelector('#chatHeader div:last-child div:last-child').textContent = 'Online';
      if (recognition) recognition.stop();
    }

    function toggleChat() {
      chatbotContainer.classList.toggle('active');
    }

    function addMessage(role, text) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.innerHTML = text;
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'id-ID';
        utter.rate = speechRate;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      }
    }

    function ruleBot(text) {
      const t = text.toLowerCase();
      if (/halo|hi|hai/.test(t)) return 'Halo! Ada yang bisa saya bantu?';
      if (/toilet/.test(t)) return 'Toilet pintar: flush otomatis, hemat air 50%, pemanas dudukan.';
      if (/sepatu|shoe/.test(t)) return 'Sepatu tahan air, anti-slip, memory foam.';
      return `Maaf, saya belum paham: "${text}". Coba tanya fitur produk!`;
    }

    async function sendToLLM(message) {
      const sku = productSelect.value;
      const endpoint = sku ? `${API_BASE}/api/llm/product-chat` : `${API_BASE}/api/llm/chat`;
      const payload = sku ? { sku, question: message } : { message };

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        return json.success ? json.data.response : ruleBot(message);
      } catch {
        return ruleBot(message);
      }
    }

    async function sendMessage(text) {
      if (!text.trim()) return;
      addMessage('user', text);
      chatInput.value = '';

      addMessage('bot', '<div style="display:flex; gap:4px;"><div class="w-2 h-2 bg-cyan-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div><div class="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div></div>');

      const reply = await sendToLLM(text);
      chatBody.lastChild.remove();
      addMessage('bot', reply);
      speak(reply);
    }

    // === MANUAL MIC (opsional) ===
    micBtn.onclick = () => {
      if (isListening) stopListening();
      else startListening();
    };

    sendBtn.onclick = () => sendMessage(chatInput.value);
    chatInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage(chatInput.value);
    });

    // === SPEED CONTROL ===
    document.querySelectorAll('.speedBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.speedBtn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        speechRate = parseFloat(btn.dataset.rate);
      });
    });

    // INIT PRODUK SELECT
    products.forEach(p => {
      if (p) {
        const opt = document.createElement('option');
        opt.value = p.sku ? p.sku[0].split(':')[0] : p.id;
        opt.textContent = `${p.name}`;
        productSelect.appendChild(opt);
      }
    });
  </script>
</body>
</html>